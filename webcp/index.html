<!DOCTYPE html>
<html>
  <head>
    <title>Button Counter</title>
    <style>
      body {
	  margin: 0;
      }
    </style>
  </head>
  <body>
    <p id="statusText"></p>
	<canvas id="canvas" width="100%" height="100%" > </canvas>
	<button onclick="console.log('Canvas',   document.getElementById('canvas'))"></button>> CLICK</button>
 <script type="module" src="wasm.module.js"></script>

<script>
	const url_arg_str = window.location.search;
	const url_params = new URLSearchParams(url_arg_str);
	const subid = url_params.get('subid');
	const box_ip = window.location.href.split('/')[2].split(':')[0];
	let ws;
	const canvas = document.getElementById('canvas');
	const context = canvas.getContext('2d');


	function resizeCanvas() {
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
		console.log("resize");
		Module.ccall('resizeWindow', null, ['number', 'number'], [canvas.width, canvas.height]);
	}

	window.addEventListener('resize', resizeCanvas, true);
	// 	window.addEventListener('resize', function(event){
	// 	console.log("resize")
	// }, true);
	resizeCanvas();

	async function start_connect()
	{
		ws = new WebSocket("ws://" + box_ip + ":50079");
		ws.onopen = (event) => {

			console.log("openned websocket")

			byte_array = new Uint8Array(1);
			byte_array[0] = subid;
			ws.send(byte_array.buffer);
			// console.log("Connection data ",byte_array.buffer, byte_array);
			// Module.ccall('setConnectionStatus', null, ['number'], [1]);
			// Message from console
			ws.addEventListener('message', (event) => {
				console.log("Received ", event.data);
				sendToWasm(event.data);
				document.getElementById("statusText").innerHTML = event.data;
			});
		}
	}

	ws.onclose = (event) =>
	{
		Module.ccall('setConnectionStatus', null, ['number'], [0]);
	}

  // wait for websocket to connect

	// JS has to convert strings into char *
	//  Do this by allocating memory
	// Must free the pointer from the C code. Coulld lead to free errors if ptr still in use when freed from JS code
	// ccall calls a C function. -> ccall(function_name, return_type, [arg types], [args]);
	async function sendToWasm(message)
	{
		const byteCount = await Module.lengthBytesUTF8(message) + 1;
		const msgPtr =  Module._malloc(byteCount);
		Module.stringToUTF8(message, msgPtr, byteCount);
		await Module.ccall('recvMessage', null, ['string'], [message]);
		// Module._free(msgPtr);

	}

	function sendToConsole(message) {
		// let copy = message
		// console.log("What??", window.Module)
		let msg = Module.UTF8ToString(message);
		console.log("Sending to console", msg);
		ws.send(msg);
	}


  </script>


</body>
</html>
